import React, { useState, useEffect, useRef } from 'react';
import { Camera, CheckCircle, XCircle, AlertCircle } from 'lucide-react';

const FacialRecognitionSystem = () => {
  const [students, setStudents] = useState([]);
  const [currentStudent, setCurrentStudent] = useState(null);
  const [status, setStatus] = useState('idle');
  const [message, setMessage] = useState('');
  const [isProcessing, setIsProcessing] = useState(false);
  const videoRef = useRef(null);
  const canvasRef = useRef(null);
  const streamRef = useRef(null);

  // Charger les données CSV au démarrage
  useEffect(() => {
    loadStudentData();
    startCamera();
    return () => stopCamera();
  }, []);

  const loadStudentData = async () => {
    try {
      const response = await fetch('./personnel.csv');
      const text = await response.text();
      const lines = text.split('\n').filter(line => line.trim());
      const headers = lines[0].split(',').map(h => h.trim());
      
      const studentData = lines.slice(1).map(line => {
        const values = line.split(',').map(v => v.trim());
        return {
          id: values[0],
          nom: values[1],
          prenom: values[2],
          classe: values[3],
          email: values[4],
          telephone: values[5]
        };
      });
      
      setStudents(studentData);
    } catch (error) {
      console.error('Erreur lors du chargement des données:', error);
      setMessage('Erreur de chargement des données');
      setStatus('error');
    }
  };

  const startCamera = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { width: 640, height: 480 }
      });
      if (videoRef.current) {
        videoRef.current.srcObject = stream;
        streamRef.current = stream;
      }
    } catch (error) {
      console.error('Erreur caméra:', error);
      setMessage('Impossible d\'accéder à la caméra');
      setStatus('error');
    }
  };

  const stopCamera = () => {
    if (streamRef.current) {
      streamRef.current.getTracks().forEach(track => track.stop());
    }
  };

  const captureAndRecognize = async () => {
    if (isProcessing) return;
    setIsProcessing(true);
    setStatus('processing');
    setMessage('Analyse en cours...');

    const canvas = canvasRef.current;
    const video = videoRef.current;
    
    if (!canvas || !video) {
      setIsProcessing(false);
      return;
    }

    const context = canvas.getContext('2d');
    canvas.width = 640;
    canvas.height = 480;
    context.drawImage(video, 0, 0, 640, 480);

    // Simulation de reconnaissance faciale
    // Dans une vraie application, utilisez face-api.js ou une API de reconnaissance
    await new Promise(resolve => setTimeout(resolve, 1500));

    // Simulation: reconnaissance aléatoire pour la démonstration
    const recognized = Math.random() > 0.3;
    
    if (recognized && students.length > 0) {
      const randomStudent = students[Math.floor(Math.random() * students.length)];
      setCurrentStudent(randomStudent);
      setStatus('authorized');
      setMessage('AUTORISÉ');
      
      // Activation du relais Arduino (broche 3)
      sendArduinoSignal(true);
      
      // Désactiver après 3 secondes
      setTimeout(() => {
        sendArduinoSignal(false);
      }, 3000);
    } else {
      setCurrentStudent(null);
      setStatus('unauthorized');
      setMessage('VOUS N\'AVEZ PAS L\'HABILITATION SUFFISANTE');
    }

    setIsProcessing(false);
  };

  const sendArduinoSignal = async (activate) => {
    try {
      // Communication avec Arduino via Serial API (nécessite Chrome/Edge)
      // Pour une vraie implémentation, utilisez Web Serial API
      console.log(`Signal Arduino broche 3: ${activate ? 'HIGH' : 'LOW'}`);
      
      // Exemple avec Web Serial API:
      // const port = await navigator.serial.requestPort();
      // await port.open({ baudRate: 9600 });
      // const writer = port.writable.getWriter();
      // await writer.write(new Uint8Array([activate ? 1 : 0]));
      // writer.releaseLock();
    } catch (error) {
      console.error('Erreur communication Arduino:', error);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-8">
      <div className="max-w-7xl mx-auto">
        {/* En-tête */}
        <div className="text-center mb-8">
          <h1 className="text-4xl font-bold text-white mb-2">
            Système de Contrôle d'Accès
          </h1>
          <p className="text-slate-400">Reconnaissance Faciale Sécurisée</p>
        </div>

        {/* Contenu principal */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          {/* Zone caméra */}
          <div className="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50 shadow-2xl">
            <div className="flex items-center gap-3 mb-4">
              <Camera className="text-blue-400" size={24} />
              <h2 className="text-xl font-semibold text-white">Caméra en Direct</h2>
            </div>
            
            <div className="relative bg-black rounded-lg overflow-hidden mb-4">
              <video
                ref={videoRef}
                autoPlay
                playsInline
                className="w-full h-auto"
                style={{ maxHeight: '480px' }}
              />
              <canvas ref={canvasRef} className="hidden" />
            </div>

            <button
              onClick={captureAndRecognize}
              disabled={isProcessing}
              className={`w-full py-4 rounded-lg font-semibold text-white transition-all transform ${
                isProcessing
                  ? 'bg-slate-600 cursor-not-allowed'
                  : 'bg-blue-600 hover:bg-blue-700 hover:scale-105 active:scale-95 shadow-lg hover:shadow-blue-500/50'
              }`}
            >
              {isProcessing ? 'Analyse en cours...' : 'Analyser le Visage'}
            </button>
          </div>

          {/* Zone informations */}
          <div className="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50 shadow-2xl">
            <div className="flex items-center gap-3 mb-4">
              <AlertCircle className="text-blue-400" size={24} />
              <h2 className="text-xl font-semibold text-white">Informations</h2>
            </div>

            {currentStudent ? (
              <div className="space-y-4">
                <div className="bg-slate-900/50 rounded-lg p-4 border border-slate-700">
                  <p className="text-sm text-slate-400 mb-1">ID Élève</p>
                  <p className="text-2xl font-bold text-white">{currentStudent.id}</p>
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div className="bg-slate-900/50 rounded-lg p-4 border border-slate-700">
                    <p className="text-sm text-slate-400 mb-1">Nom</p>
                    <p className="text-lg font-semibold text-white">{currentStudent.nom}</p>
                  </div>
                  <div className="bg-slate-900/50 rounded-lg p-4 border border-slate-700">
                    <p className="text-sm text-slate-400 mb-1">Prénom</p>
                    <p className="text-lg font-semibold text-white">{currentStudent.prenom}</p>
                  </div>
                </div>

                <div className="bg-slate-900/50 rounded-lg p-4 border border-slate-700">
                  <p className="text-sm text-slate-400 mb-1">Classe</p>
                  <p className="text-lg font-semibold text-white">{currentStudent.classe}</p>
                </div>

                <div className="bg-slate-900/50 rounded-lg p-4 border border-slate-700">
                  <p className="text-sm text-slate-400 mb-1">Email</p>
                  <p className="text-base text-white break-all">{currentStudent.email}</p>
                </div>

                <div className="bg-slate-900/50 rounded-lg p-4 border border-slate-700">
                  <p className="text-sm text-slate-400 mb-1">Téléphone</p>
                  <p className="text-lg font-semibold text-white">{currentStudent.telephone}</p>
                </div>
              </div>
            ) : (
              <div className="flex items-center justify-center h-96">
                <div className="text-center">
                  <div className="w-24 h-24 mx-auto mb-4 rounded-full bg-slate-700/50 flex items-center justify-center">
                    <Camera className="text-slate-500" size={40} />
                  </div>
                  <p className="text-slate-400 text-lg">
                    En attente de reconnaissance
                  </p>
                  <p className="text-slate-500 text-sm mt-2">
                    Cliquez sur "Analyser le Visage"
                  </p>
                </div>
              </div>
            )}
          </div>
        </div>

        {/* Message de statut */}
        {message && (
          <div className={`rounded-2xl p-8 text-center transform transition-all ${
            status === 'authorized'
              ? 'bg-green-500/20 border-2 border-green-500 shadow-lg shadow-green-500/50'
              : status === 'unauthorized'
              ? 'bg-red-500/20 border-2 border-red-500 shadow-lg shadow-red-500/50'
              : 'bg-blue-500/20 border-2 border-blue-500'
          }`}>
            <div className="flex items-center justify-center gap-4">
              {status === 'authorized' && (
                <CheckCircle className="text-green-400" size={48} />
              )}
              {status === 'unauthorized' && (
                <XCircle className="text-red-400" size={48} />
              )}
              <p className={`text-3xl font-bold ${
                status === 'authorized'
                  ? 'text-green-400'
                  : status === 'unauthorized'
                  ? 'text-red-400'
                  : 'text-blue-400'
              }`}>
                {message}
              </p>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default FacialRecognitionSystem;
