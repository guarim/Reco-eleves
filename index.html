<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Reconnaissance faciale - Accès élèves</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#f5f7fa;
    --card:#ffffff;
    --muted:#6b7280;
    --accent:#0ea5a4;
    --good:#16a34a;
    --bad:#dc2626;
    --shadow: 0 6px 18px rgba(22,24,27,0.06);
    font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  body{
    margin:0;
    background:var(--bg);
    color:#111827;
    display:flex;
    align-items:flex-start;
    justify-content:center;
    min-height:100vh;
    padding:32px;
  }
  .container{
    width:1100px;
  }
  .grid{
    display:grid;
    grid-template-columns: 640px 1fr;
    gap:24px;
  }
  .card{
    background:var(--card);
    border-radius:12px;
    padding:14px;
    box-shadow:var(--shadow);
  }
  .camera-wrap{
    width:640px;
    height:480px;
    border-radius:8px;
    background:#0f172a;
    position:relative;
  }
  canvas{
    width:640px;
    height:480px;
    border-radius:8px;
    background:black;
  }
  video{
    position:absolute;
    opacity:0;
    width:1px;
    height:1px;
    pointer-events:none;
  }
  .right{
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  h2{margin:0 0 6px 0; font-size:16px;}
  .info{
    padding:18px;
    border-radius:8px;
    background:#fafafa;
    min-height:180px;
  }
  .field{color:var(--muted); font-size:14px; margin-bottom:8px;}
  .value{font-weight:600; font-size:15px; color:#111827;}
  .message{
    margin-top:18px;
    padding:18px;
    border-radius:8px;
    text-align:center;
    font-weight:700;
    font-size:16px;
    display:none;
  }
  .message.good{ background:#ecfdf5; color:var(--good); border:1px solid rgba(22,163,74,0.12);}
  .message.bad{ background:#fff1f2; color:var(--bad); border:1px solid rgba(220,38,38,0.08);}
  .controls{ display:flex; gap:10px; align-items:center; margin-top:8px;}
  button{
    border:0;
    padding:10px 14px;
    border-radius:8px;
    font-weight:600;
    cursor:pointer;
  }
  button.primary{ background:var(--accent); color:white; }
  button.grey{ background:#eef2f7; color:#111827; }
  small{ color:var(--muted); display:block; margin-top:6px; }
  .student-photo{
    width:120px;
    height:120px;
    border-radius:8px;
    object-fit:cover;
    background:#eee;
    margin-bottom:8px;
  }
</style>
</head>

<body>
<div class="container">
  <div class="grid">

    <!-- CAMERA -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div>
          <h2>Caméra</h2>
          <small>Format 640×480</small>
        </div>
        <button id="serialButton" class="primary">Connecter Arduino</button>
      </div>

      <div class="camera-wrap">
        <canvas id="cameraCanvas" width="640" height="480"></canvas>
        <video id="video" autoplay muted playsinline></video>
      </div>

      <div class="controls">
        <button id="startBtn" class="primary">Démarrer reconnaissance</button>
        <button id="stopBtn" class="grey" disabled>Arrêter</button>
        <small id="statusText">Initialisation...</small>
      </div>
    </div>

    <!-- INFO -->
    <div class="card right">
      <h2>Informations élève</h2>

      <div class="info">
        <img id="studentPhoto" class="student-photo" src="">
        <div class="field">ID : <span class="value" id="s-id">—</span></div>
        <div class="field">Nom : <span class="value" id="s-name">—</span></div>
        <div class="field">Classe : <span class="value" id="s-class">—</span></div>
        <div class="field">Email : <span class="value" id="s-email">—</span></div>
        <div class="field">Autre : <span class="value" id="s-other">—</span></div>
      </div>

      <div id="messageArea" class="message"></div>
    </div>

  </div>
</div>

<!-- LIBS -->
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/face-api.js@0.22.2/dist/face-api.min.js"></script>

<script>
const MODELS_URL = "./models";
const CSV_URL = "./eleves.csv";
const ASSETS_DIR = "./assets";

const video = document.getElementById("video");
const canvas = document.getElementById("cameraCanvas");
const ctx = canvas.getContext("2d");

const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const statusText = document.getElementById("statusText");
const messageArea = document.getElementById("messageArea");
const serialButton = document.getElementById("serialButton");

let students = new Map();
let labeledDescriptors = [];
let faceMatcher = null;

let stream = null;
let detectionLoop = null;

let serialPort = null;
let serialWriter = null;

const MATCH_THRESHOLD = 0.5;
let lastAuth = 0;

function showMsg(txt, ok){
  messageArea.textContent = txt;
  messageArea.className = ok ? "message good" : "message bad";
  messageArea.style.display = "block";
}

function clearMsg(){ messageArea.style.display = "none"; }

function showStudent(s){
  document.getElementById("s-id").textContent = s.id;
  document.getElementById("s-name").textContent = s.name;
  document.getElementById("s-class").textContent = s.class;
  document.getElementById("s-email").textContent = s.email;
  document.getElementById("s-other").textContent = s.other;
  document.getElementById("studentPhoto").src = `${ASSETS_DIR}/${s.id}.png`;
}

function clearStudent(){
  ["s-id","s-name","s-class","s-email","s-other"].forEach(id=>{
    document.getElementById(id).textContent = "—";
  });
  document.getElementById("studentPhoto").src = "";
}

async function sendSerial(cmd){
  if(!serialWriter) return;
  await serialWriter.write(new TextEncoder().encode(cmd+"\n"));
}

async function connectSerial(){
  if(!("serial" in navigator)){
    alert("Web Serial non supporté (Chrome/Edge requis).");
    return;
  }
  try{
    serialPort = await navigator.serial.requestPort();
    await serialPort.open({ baudRate:115200 });
    serialWriter = serialPort.writable.getWriter();
    serialButton.textContent = "Arduino connecté";
    serialButton.disabled = true;
  }catch(e){
    alert("Erreur connexion Arduino : "+e.message);
  }
}

serialButton.onclick = connectSerial;

async function startCamera(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video: { width:640, height:480, facingMode:"user" },
      audio:false
    });

    video.srcObject = stream;

    return new Promise(resolve=>{
      video.onloadedmetadata = ()=>{
        video.play().then(()=>{
          statusText.textContent = "Caméra prête";
          resolve();
        });
      };
    });

  }catch(e){
    statusText.textContent = "Erreur caméra : "+e.message;
    alert("Caméra indisponible ou refusée.");
  }
}

async function stopCamera(){
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream = null;
  }
}

async function loadCSV(){
  const r = await fetch(CSV_URL+"?nocache="+Date.now());
  const txt = await r.text();
  const parsed = Papa.parse(txt,{header:true,skipEmptyLines:true});
  parsed.data.forEach(row=>{
    const id = String(row.id).trim();
    if(!id) return;
    students.set(id,{id,name:row.name,class:row.class,email:row.email,other:row.other});
  });
}

async function buildDescriptors(){
  for(const [id, s] of students.entries()){
    try{
      const img = await faceapi.fetchImage(`${ASSETS_DIR}/${id}.png`);
      const d = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
      if(d){
        labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(id,[d.descriptor]));
        statusText.textContent = `Descriptors : ${labeledDescriptors.length}`;
      }
    }catch(e){}
  }
}

async function startRecognition(){
  startBtn.disabled = true;
  stopBtn.disabled = false;

  await startCamera();

  faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, MATCH_THRESHOLD);

  detectionLoop = setInterval(async ()=>{
    if(!stream) return;

    ctx.drawImage(video, 0,0,640,480);

    const det = await faceapi.detectSingleFace(video,new faceapi.TinyFaceDetectorOptions())
      .withFaceLandmarks().withFaceDescriptor();

    if(!det){
      clearStudent();
      showMsg("Aucun visage détecté",0);
      return;
    }

    const match = faceMatcher.findBestMatch(det.descriptor);
    if(match.label !== "unknown"){
      const s = students.get(match.label);
      showStudent(s);
      showMsg("AUTORISÉ",1);

      if(Date.now()-lastAuth > 3000){
        lastAuth = Date.now();
        sendSerial("OPEN:"+s.id);
      }

    }else{
      clearStudent();
      showMsg("VOUS N'AVEZ PAS L'HABILITATION",0);
    }

  }, 300);
}

function stopRecognition(){
  clearInterval(detectionLoop);
  detectionLoop = null;
  stopCamera();

  startBtn.disabled = false;
  stopBtn.disabled = true;

  clearStudent();
  clearMsg();
  ctx.clearRect(0,0,640,480);
}


startBtn.onclick = startRecognition;
stopBtn.onclick = stopRecognition;

async function init(){
  statusText.textContent = "Chargement modèles...";
  await faceapi.nets.tinyFaceDetector.loadFromUri(MODELS_URL);
  await faceapi.nets.faceLandmark68Net.loadFromUri(MODELS_URL);
  await faceapi.nets.faceRecognitionNet.loadFromUri(MODELS_URL);

  statusText.textContent = "Chargement CSV...";
  await loadCSV();

  statusText.textContent = "Calcul descriptors...";
  await buildDescriptors();

  statusText.textContent = "Prêt.";
}

window.onload = init;
</script>
</body>
</html>
